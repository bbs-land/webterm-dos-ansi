#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
LIB_PKG="$PROJECT_ROOT/projects/lib/pkg"
ANSI_VIEW="$PROJECT_ROOT/projects/ansi-view"
ASSETS_LIB="$ANSI_VIEW/assets/lib"

# Check if lib/pkg exists and has content, build if not
if [ ! -d "$LIB_PKG" ] || [ -z "$(ls -A "$LIB_PKG" 2>/dev/null)" ]; then
    echo "lib/pkg directory is empty or does not exist. Building library..."
    if ! "$SCRIPT_DIR/lib-build"; then
        echo "Error: lib-build failed." >&2
        exit 1
    fi
fi

# Clear and recreate assets/lib directory
echo "Copying library files..."
rm -rf "$ASSETS_LIB"
mkdir -p "$ASSETS_LIB"
cp -r "$LIB_PKG"/* "$ASSETS_LIB/"
echo "Library files copied to assets/lib/"

# Start the file server
echo "Starting file server..."
cd "$ANSI_VIEW"
exec deno run --allow-net --allow-read --allow-sys jsr:@std/http/file-server -v
